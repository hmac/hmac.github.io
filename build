#!/usr/bin/env stack
-- stack --resolver lts-12.2 --install-ghc runghc --package hakyll --package pandoc

-- vim: ft=haskell

{-# LANGUAGE OverloadedStrings  #-}

import Hakyll
import Data.ByteString (ByteString)
import qualified Data.ByteString as B
import Text.Pandoc
import System.Process ( readProcess )
import System.IO.Unsafe ( unsafePerformIO )
import Text.Pandoc.Walk ( walk )

main =
  hakyll $ do
    match "templates/*" $ compile $ templateCompiler
    match "css/*" $ do
        route   idRoute
        compile compressCssCompiler

    match "posts/*" $ do
      route $ setExtension ".html"
      compile $ pandocGraphvizCompiler
        >>= loadAndApplyTemplate "templates/default.html" defaultContext
        >>= relativizeUrls
    match "index.html" $ do
        route idRoute
        compile $ do
          posts <- recentFirst =<< loadAll "posts/*"
          let indexContext =
                  listField "posts" defaultContext (pure posts) <>
                  defaultContext

          getResourceBody
              >>= applyAsTemplate indexContext
              >>= loadAndApplyTemplate "templates/default.html" indexContext
              >>= relativizeUrls

pandocGraphvizCompiler :: Compiler (Item String)
pandocGraphvizCompiler = pandocCompilerWithTransform
    defaultHakyllReaderOptions
    defaultHakyllWriterOptions
    graphViz

graphViz :: Pandoc -> Pandoc
graphViz = walk codeBlock

codeBlock :: Block -> Block
codeBlock cb@(CodeBlock (id, classes, namevals) contents) =
    if "dot" `elem` classes
    then RawBlock (Format "html") $ svg contents
    else cb
codeBlock x = x

svg :: String -> String
svg contents = unsafePerformIO $ readProcess "dot" ["-Tsvg"] contents
