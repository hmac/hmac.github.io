<!doctype html>
<html>
  <head>
  <title>Implementing A Functional Language Part II: Graph Reduction | hmac.dev</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../css/syntax.css" />
  <style>
    html {
      height: 100%;
    }
    body { 
      height: 100%;
      background-color: #fff;
      margin: 0px 0px 0px 0px;
    }
    .main {
      min-height: 100%;
      max-width: 900px;
      font-family: Helvetica Neue;
      font-size: 16px;
      line-height: 1.7em;
    }
    .content {
      margin: 0px auto 0px auto;
      padding-bottom: 8px;
      padding-left: 10px;
      padding-right: 10px;
      color: #333;
      font-size: 1.1em;
    }
    .content code:not(.sourceCode) {
      background-color: #f7f5ef;
      color: #444;
    }
    div.sourceCode {
      padding: 5px;
    }
    @media (min-width: 701px) {
      .main {
        margin: 0px auto 0px auto;
      }
    }
    @media (max-width: 700px) {
      .main {
        margin: 0px 0px 0px 0px;
      }
      .content {
        max-width: 600px;
        margin: 0px auto 0px auto;
      }
    }
    @media (max-width: 600px) {
      .main {
        margin: 0px 0px 0px 0px;
      }
      .content {
        max-width: 700px;
        margin: 0px 8px 0px 8px;
      }
      .sourceCode {
        font-size: 13px;
      }
    }
    h1, h2, h3 {
      font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
      font-weight: normal;
    }
    ol#post-list {
      list-style-type: none
    }
    #header {
      border-bottom: 1px solid black;
      padding: 10px 0px 10px 0px;
      position: relative;
      min-height: 30px;
    }
    #header a {
      text-decoration: none;
    }
    #header #back {
      position: absolute;
      left: 0;
    }
    #header #date {
      position: absolute;
      right: 1em;
    }
    #header #name {
      position: absolute;
      right: 1em;
    }

    a {
      text-decoration: none;
      color: #e6851f;
    }
    a:visited {
      text-decoration: none;
      color: #e6851f;
    }
    a:hover {
      text-decoration: none;
      color: #233248;
    }
    .project p {
      margin-left: 1em;
    }
  </style>
</head>

  <body>
    <div class="main">
      <div id="header">
        <a id="back" href="../">↩</a>
        <div id="date">March  9, 2019</div>
      </div>
      <div class="content">
        <h1 id="implementing-a-functional-language-ii-graph-reduction">Implementing a Functional Language II: Graph Reduction</h1>
<p>This is part 2 of a series in implementing a functional language. The introduction is
<a href="2019-03-02-implementing-a-functional-language.html">here</a>.</p>
<hr />
<p>Every compilation strategy we will cover in this series will be based on the same core
concept: lazy graph reduction. This idea is simple but powerful, and it’s what we’ll
introduce in this section.</p>
<p>A functional program is really just a single large expression which evaluates to a result.
We can model it as a graph<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> of nested applications. For example, the expression <code>f 1 2</code>
looks like this:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="242pt" height="188pt" viewBox="0.00 0.00 242.00 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<polygon fill="white" stroke="none" points="-4,4 -4,-184 238,-184 238,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="162" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="162" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="72" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="72" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M144.65,-148.12C131.53,-137.63 113.31,-123.05 98.39,-111.11"></path>
<polygon fill="black" stroke="black" points="100.78,-108.54 90.79,-105.03 96.41,-114.01 100.78,-108.54"></polygon>
</g>
<!-- 2 -->
<g id="node3" class="node">
<title>2</title>
<ellipse fill="none" stroke="black" cx="207" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="207" y="-84.58" font-family="Courier,monospace" font-size="14.00">2</text>
</g>
<!-- a&#45;&gt;2 -->
<g id="edge2" class="edge">
<title>a-&gt;2</title>
<path fill="none" stroke="black" d="M172.44,-145.3C177.83,-136.67 184.54,-125.93 190.61,-116.22"></path>
<polygon fill="black" stroke="black" points="193.49,-118.23 195.82,-107.89 187.55,-114.52 193.49,-118.23"></polygon>
</g>
<!-- f -->
<g id="node4" class="node">
<title>f</title>
<ellipse fill="none" stroke="black" cx="27" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-12.57" font-family="Courier,monospace" font-size="14.00">f</text>
</g>
<!-- b&#45;&gt;f -->
<g id="edge3" class="edge">
<title>b-&gt;f</title>
<path fill="none" stroke="black" d="M61.56,-73.3C56.17,-64.67 49.46,-53.93 43.39,-44.22"></path>
<polygon fill="black" stroke="black" points="46.45,-42.52 38.18,-35.89 40.51,-46.23 46.45,-42.52"></polygon>
</g>
<!-- 1 -->
<g id="node5" class="node">
<title>1</title>
<ellipse fill="none" stroke="black" cx="117" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="117" y="-12.57" font-family="Courier,monospace" font-size="14.00">1</text>
</g>
<!-- b&#45;&gt;1 -->
<g id="edge4" class="edge">
<title>b-&gt;1</title>
<path fill="none" stroke="black" d="M82.44,-73.3C87.83,-64.67 94.54,-53.93 100.61,-44.22"></path>
<polygon fill="black" stroke="black" points="103.49,-46.23 105.82,-35.89 97.55,-42.52 103.49,-46.23"></polygon>
</g>
</g>
</svg>

<p>We use the symbol <code>@</code> to denote an application node. Note that though <code>f</code> takes two
arguments, we apply each in turn via currying. Here’s a more complicated example - the
graph of <code>(+ (* 2 3) 4)</code>:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="422pt" height="332pt" viewBox="0.00 0.00 422.00 332.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 328)">
<polygon fill="white" stroke="none" points="-4,4 -4,-328 418,-328 418,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="342" cy="-306" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="342" y="-300.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="72" cy="-234" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="72" y="-228.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M316.6,-299.23C268.56,-286.42 164.22,-258.59 108.62,-243.76"></path>
<polygon fill="black" stroke="black" points="109.56,-240.39 98.99,-241.2 107.75,-247.16 109.56,-240.39"></polygon>
</g>
<!-- 4 -->
<g id="node3" class="node">
<title>4</title>
<ellipse fill="none" stroke="black" cx="387" cy="-234" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="387" y="-228.57" font-family="Courier,monospace" font-size="14.00">4</text>
</g>
<!-- a&#45;&gt;4 -->
<g id="edge2" class="edge">
<title>a-&gt;4</title>
<path fill="none" stroke="black" d="M352.44,-289.3C357.83,-280.67 364.54,-269.93 370.61,-260.22"></path>
<polygon fill="black" stroke="black" points="373.49,-262.23 375.82,-251.89 367.55,-258.52 373.49,-262.23"></polygon>
</g>
<!-- + -->
<g id="node4" class="node">
<title>+</title>
<ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-156.57" font-family="Courier,monospace" font-size="14.00">+</text>
</g>
<!-- b&#45;&gt;+ -->
<g id="edge3" class="edge">
<title>b-&gt;+</title>
<path fill="none" stroke="black" d="M61.56,-217.3C56.17,-208.67 49.46,-197.93 43.39,-188.22"></path>
<polygon fill="black" stroke="black" points="46.45,-186.52 38.18,-179.89 40.51,-190.23 46.45,-186.52"></polygon>
</g>
<!-- c -->
<g id="node5" class="node">
<title>c</title>
<ellipse fill="none" stroke="black" cx="252" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="252" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b&#45;&gt;c -->
<g id="edge4" class="edge">
<title>b-&gt;c</title>
<path fill="none" stroke="black" d="M95.53,-224.59C126.79,-212.08 182.23,-189.91 218.03,-175.59"></path>
<polygon fill="black" stroke="black" points="219.07,-178.94 227.06,-171.98 216.47,-172.44 219.07,-178.94"></polygon>
</g>
<!-- d -->
<g id="node6" class="node">
<title>d</title>
<ellipse fill="none" stroke="black" cx="162" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="162" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- c&#45;&gt;d -->
<g id="edge5" class="edge">
<title>c-&gt;d</title>
<path fill="none" stroke="black" d="M234.65,-148.12C221.53,-137.63 203.31,-123.05 188.39,-111.11"></path>
<polygon fill="black" stroke="black" points="190.78,-108.54 180.79,-105.03 186.41,-114.01 190.78,-108.54"></polygon>
</g>
<!-- 3 -->
<g id="node7" class="node">
<title>3</title>
<ellipse fill="none" stroke="black" cx="297" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="297" y="-84.58" font-family="Courier,monospace" font-size="14.00">3</text>
</g>
<!-- c&#45;&gt;3 -->
<g id="edge6" class="edge">
<title>c-&gt;3</title>
<path fill="none" stroke="black" d="M262.44,-145.3C267.83,-136.67 274.54,-125.93 280.61,-116.22"></path>
<polygon fill="black" stroke="black" points="283.49,-118.23 285.82,-107.89 277.55,-114.52 283.49,-118.23"></polygon>
</g>
<!-- * -->
<g id="node8" class="node">
<title>*</title>
<ellipse fill="none" stroke="black" cx="117" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="117" y="-12.57" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- d&#45;&gt;* -->
<g id="edge7" class="edge">
<title>d-&gt;*</title>
<path fill="none" stroke="black" d="M151.56,-73.3C146.17,-64.67 139.46,-53.93 133.39,-44.22"></path>
<polygon fill="black" stroke="black" points="136.45,-42.52 128.18,-35.89 130.51,-46.23 136.45,-42.52"></polygon>
</g>
<!-- 2 -->
<g id="node9" class="node">
<title>2</title>
<ellipse fill="none" stroke="black" cx="207" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="207" y="-12.57" font-family="Courier,monospace" font-size="14.00">2</text>
</g>
<!-- d&#45;&gt;2 -->
<g id="edge8" class="edge">
<title>d-&gt;2</title>
<path fill="none" stroke="black" d="M172.44,-73.3C177.83,-64.67 184.54,-53.93 190.61,-44.22"></path>
<polygon fill="black" stroke="black" points="193.49,-46.23 195.82,-35.89 187.55,-42.52 193.49,-46.23"></polygon>
</g>
</g>
</svg>

<p>To evaluate the program, we’ll repeatedly <em>reduce</em> expressions in the graph. We’ll stop
when there are no expressions left to reduce. The resulting graph is the result of the
program. Reducing an expression typically involves applying a function to one or more
arguments, producing a result, and then replacing the expression with the result.</p>
<p>Not all expressions can be reduced: <code>+ 1 2</code> reduces to <code>3</code> but <code>3</code> does not reduce any
further. Similarly, <code>+ 1</code> does not reduce because <code>+</code> requires two arguments. An
expression which is reducible is known as a reducible expression, or redex. To evaluate an
entire program, all we need to do is repeatedly identify the next redex to reduce, and
then reduce it, stopping when there are no redexes left.</p>
<p>Let’s try to reduce the graph above. We start at the top, with an application node <code>@</code>.
The child nodes are <code>@</code> (another application) and <code>4</code>. We can’t immediately evaluate this
expression, so we proceed down into the child application node, which itself has children
<code>+</code> and <code>@</code>. <code>+</code> takes two arguments, in this case <code>(* 2 3)</code> and <code>4</code>. <code>+</code> also requires
that both its arguments are evaluated, so we need to continue to reduce the first
argument. We descend into the right hand application node - the root of <code>(* 2 3)</code>. Here’s
where we are in the graph:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="422pt" height="332pt" viewBox="0.00 0.00 422.00 332.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 328)">
<polygon fill="white" stroke="none" points="-4,4 -4,-328 418,-328 418,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="342" cy="-306" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="342" y="-300.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="72" cy="-234" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="72" y="-228.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M316.6,-299.23C268.56,-286.42 164.22,-258.59 108.62,-243.76"></path>
<polygon fill="black" stroke="black" points="109.56,-240.39 98.99,-241.2 107.75,-247.16 109.56,-240.39"></polygon>
</g>
<!-- 4 -->
<g id="node3" class="node">
<title>4</title>
<ellipse fill="none" stroke="black" cx="387" cy="-234" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="387" y="-228.57" font-family="Courier,monospace" font-size="14.00">4</text>
</g>
<!-- a&#45;&gt;4 -->
<g id="edge2" class="edge">
<title>a-&gt;4</title>
<path fill="none" stroke="black" d="M352.44,-289.3C357.83,-280.67 364.54,-269.93 370.61,-260.22"></path>
<polygon fill="black" stroke="black" points="373.49,-262.23 375.82,-251.89 367.55,-258.52 373.49,-262.23"></polygon>
</g>
<!-- + -->
<g id="node4" class="node">
<title>+</title>
<ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-156.57" font-family="Courier,monospace" font-size="14.00">+</text>
</g>
<!-- b&#45;&gt;+ -->
<g id="edge3" class="edge">
<title>b-&gt;+</title>
<path fill="none" stroke="black" d="M61.56,-217.3C56.17,-208.67 49.46,-197.93 43.39,-188.22"></path>
<polygon fill="black" stroke="black" points="46.45,-186.52 38.18,-179.89 40.51,-190.23 46.45,-186.52"></polygon>
</g>
<!-- c -->
<g id="node5" class="node">
<title>c</title>
<ellipse fill="none" stroke="red" cx="252" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="252" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b&#45;&gt;c -->
<g id="edge4" class="edge">
<title>b-&gt;c</title>
<path fill="none" stroke="black" d="M95.53,-224.59C126.79,-212.08 182.23,-189.91 218.03,-175.59"></path>
<polygon fill="black" stroke="black" points="219.07,-178.94 227.06,-171.98 216.47,-172.44 219.07,-178.94"></polygon>
</g>
<!-- d -->
<g id="node6" class="node">
<title>d</title>
<ellipse fill="none" stroke="black" cx="162" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="162" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- c&#45;&gt;d -->
<g id="edge5" class="edge">
<title>c-&gt;d</title>
<path fill="none" stroke="black" d="M234.65,-148.12C221.53,-137.63 203.31,-123.05 188.39,-111.11"></path>
<polygon fill="black" stroke="black" points="190.78,-108.54 180.79,-105.03 186.41,-114.01 190.78,-108.54"></polygon>
</g>
<!-- 3 -->
<g id="node7" class="node">
<title>3</title>
<ellipse fill="none" stroke="black" cx="297" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="297" y="-84.58" font-family="Courier,monospace" font-size="14.00">3</text>
</g>
<!-- c&#45;&gt;3 -->
<g id="edge6" class="edge">
<title>c-&gt;3</title>
<path fill="none" stroke="black" d="M262.44,-145.3C267.83,-136.67 274.54,-125.93 280.61,-116.22"></path>
<polygon fill="black" stroke="black" points="283.49,-118.23 285.82,-107.89 277.55,-114.52 283.49,-118.23"></polygon>
</g>
<!-- * -->
<g id="node8" class="node">
<title>*</title>
<ellipse fill="none" stroke="black" cx="117" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="117" y="-12.57" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- d&#45;&gt;* -->
<g id="edge7" class="edge">
<title>d-&gt;*</title>
<path fill="none" stroke="black" d="M151.56,-73.3C146.17,-64.67 139.46,-53.93 133.39,-44.22"></path>
<polygon fill="black" stroke="black" points="136.45,-42.52 128.18,-35.89 130.51,-46.23 136.45,-42.52"></polygon>
</g>
<!-- 2 -->
<g id="node9" class="node">
<title>2</title>
<ellipse fill="none" stroke="black" cx="207" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="207" y="-12.57" font-family="Courier,monospace" font-size="14.00">2</text>
</g>
<!-- d&#45;&gt;2 -->
<g id="edge8" class="edge">
<title>d-&gt;2</title>
<path fill="none" stroke="black" d="M172.44,-73.3C177.83,-64.67 184.54,-53.93 190.61,-44.22"></path>
<polygon fill="black" stroke="black" points="193.49,-46.23 195.82,-35.89 187.55,-42.52 193.49,-46.23"></polygon>
</g>
</g>
</svg>

<p>As before, we descend into the child application node, finally reaching <code>*</code>. <code>*</code> takes two
numeric arguments, and we have two arguments in <code>2</code> and <code>3</code>. We’ve found a reducible
expression! Specifically, the subgraph</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="242pt" height="188pt" viewBox="0.00 0.00 242.00 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<polygon fill="white" stroke="none" points="-4,4 -4,-184 238,-184 238,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="red" cx="162" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="162" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="72" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="72" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M144.65,-148.12C131.53,-137.63 113.31,-123.05 98.39,-111.11"></path>
<polygon fill="black" stroke="black" points="100.78,-108.54 90.79,-105.03 96.41,-114.01 100.78,-108.54"></polygon>
</g>
<!-- 3 -->
<g id="node3" class="node">
<title>3</title>
<ellipse fill="none" stroke="black" cx="207" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="207" y="-84.58" font-family="Courier,monospace" font-size="14.00">3</text>
</g>
<!-- a&#45;&gt;3 -->
<g id="edge2" class="edge">
<title>a-&gt;3</title>
<path fill="none" stroke="black" d="M172.44,-145.3C177.83,-136.67 184.54,-125.93 190.61,-116.22"></path>
<polygon fill="black" stroke="black" points="193.49,-118.23 195.82,-107.89 187.55,-114.52 193.49,-118.23"></polygon>
</g>
<!-- * -->
<g id="node4" class="node">
<title>*</title>
<ellipse fill="none" stroke="black" cx="27" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-12.57" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- b&#45;&gt;* -->
<g id="edge3" class="edge">
<title>b-&gt;*</title>
<path fill="none" stroke="black" d="M61.56,-73.3C56.17,-64.67 49.46,-53.93 43.39,-44.22"></path>
<polygon fill="black" stroke="black" points="46.45,-42.52 38.18,-35.89 40.51,-46.23 46.45,-42.52"></polygon>
</g>
<!-- 2 -->
<g id="node5" class="node">
<title>2</title>
<ellipse fill="none" stroke="black" cx="117" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="117" y="-12.57" font-family="Courier,monospace" font-size="14.00">2</text>
</g>
<!-- b&#45;&gt;2 -->
<g id="edge4" class="edge">
<title>b-&gt;2</title>
<path fill="none" stroke="black" d="M82.44,-73.3C87.83,-64.67 94.54,-53.93 100.61,-44.22"></path>
<polygon fill="black" stroke="black" points="103.49,-46.23 105.82,-35.89 97.55,-42.52 103.49,-46.23"></polygon>
</g>
</g>
</svg>

<p>can be reduced to the single numeric node <code>6</code>. The node marked in red is the <em>root</em> of
the redex. Performing the reduction, the graph now looks like this:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="242pt" height="188pt" viewBox="0.00 0.00 242.00 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<polygon fill="white" stroke="none" points="-4,4 -4,-184 238,-184 238,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="162" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="162" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="72" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="72" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M144.65,-148.12C131.53,-137.63 113.31,-123.05 98.39,-111.11"></path>
<polygon fill="black" stroke="black" points="100.78,-108.54 90.79,-105.03 96.41,-114.01 100.78,-108.54"></polygon>
</g>
<!-- 4 -->
<g id="node3" class="node">
<title>4</title>
<ellipse fill="none" stroke="black" cx="207" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="207" y="-84.58" font-family="Courier,monospace" font-size="14.00">4</text>
</g>
<!-- a&#45;&gt;4 -->
<g id="edge2" class="edge">
<title>a-&gt;4</title>
<path fill="none" stroke="black" d="M172.44,-145.3C177.83,-136.67 184.54,-125.93 190.61,-116.22"></path>
<polygon fill="black" stroke="black" points="193.49,-118.23 195.82,-107.89 187.55,-114.52 193.49,-118.23"></polygon>
</g>
<!-- + -->
<g id="node4" class="node">
<title>+</title>
<ellipse fill="none" stroke="black" cx="27" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-12.57" font-family="Courier,monospace" font-size="14.00">+</text>
</g>
<!-- b&#45;&gt;+ -->
<g id="edge3" class="edge">
<title>b-&gt;+</title>
<path fill="none" stroke="black" d="M61.56,-73.3C56.17,-64.67 49.46,-53.93 43.39,-44.22"></path>
<polygon fill="black" stroke="black" points="46.45,-42.52 38.18,-35.89 40.51,-46.23 46.45,-42.52"></polygon>
</g>
<!-- c -->
<g id="node5" class="node">
<title>c</title>
<ellipse fill="none" stroke="red" cx="117" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="117" y="-12.57" font-family="Courier,monospace" font-size="14.00">6</text>
</g>
<!-- b&#45;&gt;c -->
<g id="edge4" class="edge">
<title>b-&gt;c</title>
<path fill="none" stroke="black" d="M82.44,-73.3C87.83,-64.67 94.54,-53.93 100.61,-44.22"></path>
<polygon fill="black" stroke="black" points="103.49,-46.23 105.82,-35.89 97.55,-42.52 103.49,-46.23"></polygon>
</g>
</g>
</svg>

<p>Notice that the expression <code>(* 2 3)</code> has been replaced with the result of its reduction
(<code>6</code>). Proceeding back up graph, we can see that the arguments to <code>+</code> are now both
evaluated, so we’ve found another redex. Reducing this, we end up with a single node <code>10</code>,
which is the result of the whole expression.</p>
<h2 id="reduction-order">Reduction order</h2>
<p>The order in which we reduce expressions in a program has a profound effect on the
behaviour of the program. The approach we used in reducing the program above is called
<em>normal order reduction</em>. Normal order reduction requires that we reduce the leftmost
outermost redex first.</p>
<p>One consequence of this is that we reduce applications before reducing their arguments.
This is in contrast to a typical imperative language, where arguments to functions are
evaluated before the function is called. Take for example the following Core program:</p>
<pre><code>K x y = x
main = K 1 (/ 1 0)</code></pre>
<p>where we can assume that <code>(/ 1 0)</code> will raise an error if evaluated. Following normal
order reduction, we will reduce the application of <code>K</code> first, resulting in the following:</p>
<pre><code>main = 1</code></pre>
<p>Since the second argument to <code>K</code> is never used, we never evaluate it. In a typical
imperative language, we would evaluate <code>(/ 1 0)</code> first, resulting in an error. This style
of execution is called <em>lazy evaluation</em>, in contrast to <em>strict evaluation</em>. The two key
properties of lazy evaluation are the following:</p>
<ul>
<li>Arguments to functions are only evaluated when needed.</li>
<li>Each argument is only evaluated once - further uses of the argument will use the result
from the initial evaluation.</li>
</ul>
<p>The second property doesn’t affect program behaviour but greatly improves efficiency.</p>
<h2 id="normal-form-and-weak-head-normal-form">Normal form and Weak head normal form</h2>
<p>Normal order reduction specifies that we reduce the leftmost outermost redex first,
but it doesn’t specify when to <em>stop</em>. A natural assumption is to stop when there are no
redexes left, but this is not our only option. If the output of our program is being
printed to the screen, and we want to show progress as we go (or we’re printing an
infinite stream of values) then we want to be able to produce output without having fulling
evaluated it yet. Imagine a list made from a series of <code>Cons</code> cells linked together: we
may want to print the first element before having evaluated the whole list.</p>
<p>To do this, we need to stop reducing when there is no longer a <em>top-level</em> redex. This
will allow us to inspect the structure and decide what to evaluate next. An expression
which has no top-level redexes (but may have inner redexes left) is in <em>weak head normal
form</em> (WHNF). An expression which has no redexes at all is in <em>normal form</em> (NF). All
expressions in NF are also in WHNF, but not vice versa. Here are some examples.</p>
<table>
<thead>
<tr>
<th>Normal Form</th>
<th>Weak Head Normal Form</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>3</code></td>
<td><code>3</code></td>
</tr>
<tr>
<td><code>(+ 1)</code></td>
<td><code>(+ 1)</code></td>
</tr>
<tr>
<td></td>
<td><code>(+ (+ 2 3))</code></td>
</tr>
</tbody>
</table>
<p>For Core we’ll follow lazy evaluation and evaluate expressions to WHNF. For some built in
functions (like <code>+</code>) we will adopt strict semantics, requiring arguments to be fully
evaluated to normal form. For all user-defined functions we’ll use lazy semantics.</p>
<h2 id="reducing-programs">Reducing programs</h2>
<p>Let’s walk through the evaluation of the following program:</p>
<pre><code>square x = * x x ;
main = square (square 3)</code></pre>
<p>To start with, the graph of our program consists of just the node <code>main</code>. For reference
we’ve also drawn the graph of the supercombinator <code>square</code>, though we don’t evaluate this
until it appears in <code>main</code>.</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="105pt" height="44pt" viewBox="0.00 0.00 105.14 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<polygon fill="white" stroke="none" points="-4,4 -4,-40 101.14,-40 101.14,4 -4,4"></polygon>
<!-- main -->
<g id="node1" class="node">
<title>main</title>
<ellipse fill="none" stroke="black" cx="48.57" cy="-18" rx="48.57" ry="18"></ellipse>
<text text-anchor="middle" x="48.57" y="-12.57" font-family="Courier,monospace" font-size="14.00">main</text>
</g>
</g>
</svg>

<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="134pt" height="213pt" viewBox="0.00 0.00 134.00 212.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 208.5)">
<polygon fill="white" stroke="none" points="-4,4 -4,-208.5 130,-208.5 130,4 -4,4"></polygon>
<text text-anchor="middle" x="63" y="-7.2" font-family="Times,serif" font-size="14.00">square</text>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="71" cy="-186.5" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="71" y="-181.07" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="44" cy="-114.5" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="44" y="-109.08" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M64.46,-168.55C61.48,-160.82 57.87,-151.46 54.52,-142.77"></path>
<polygon fill="black" stroke="black" points="57.88,-141.77 51.02,-133.7 51.35,-144.29 57.88,-141.77"></polygon>
</g>
<!-- x -->
<g id="node4" class="node">
<title>x</title>
<ellipse fill="none" stroke="black" cx="99" cy="-42.5" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-37.08" font-family="Courier,monospace" font-size="14.00">x</text>
</g>
<!-- a&#45;&gt;x -->
<g id="edge3" class="edge">
<title>a-&gt;x</title>
<path fill="none" stroke="black" d="M74.38,-168.37C79.11,-144.38 87.76,-100.49 93.45,-71.66"></path>
<polygon fill="black" stroke="black" points="96.82,-72.66 95.32,-62.17 89.95,-71.31 96.82,-72.66"></polygon>
</g>
<!-- * -->
<g id="node3" class="node">
<title>*</title>
<ellipse fill="none" stroke="black" cx="27" cy="-42.5" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-37.08" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- b&#45;&gt;* -->
<g id="edge2" class="edge">
<title>b-&gt;*</title>
<path fill="none" stroke="black" d="M39.88,-96.55C38.07,-89.1 35.9,-80.14 33.85,-71.72"></path>
<polygon fill="black" stroke="black" points="37.31,-71.14 31.55,-62.25 30.51,-72.79 37.31,-71.14"></polygon>
</g>
<!-- b&#45;&gt;x -->
<g id="edge4" class="edge">
<title>b-&gt;x</title>
<path fill="none" stroke="black" d="M56.21,-97.96C63.11,-89.17 71.91,-77.98 79.73,-68.03"></path>
<polygon fill="black" stroke="black" points="82.47,-70.21 85.89,-60.18 76.96,-65.88 82.47,-70.21"></polygon>
</g>
</g>
</svg>

<p><code>main</code> is a
supercombinator with no arguments, so it is a redex. We reduce it by replacing it with its
body, yielding the following graph:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="404pt" height="188pt" viewBox="0.00 0.00 404.13 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<polygon fill="white" stroke="none" points="-4,4 -4,-184 400.13,-184 400.13,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="red" cx="153.06" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="153.06" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- square1 -->
<g id="node2" class="node">
<title>square1</title>
<ellipse fill="none" stroke="black" cx="67.53" cy="-90" rx="67.53" ry="18"></ellipse>
<text text-anchor="middle" x="67.53" y="-84.58" font-family="Courier,monospace" font-size="14.00">square</text>
</g>
<!-- a&#45;&gt;square1 -->
<g id="edge1" class="edge">
<title>a-&gt;square1</title>
<path fill="none" stroke="black" d="M136.17,-147.78C125.01,-138.39 110.1,-125.83 97.02,-114.82"></path>
<polygon fill="black" stroke="black" points="99.39,-112.24 89.49,-108.48 94.88,-117.6 99.39,-112.24"></polygon>
</g>
<!-- b -->
<g id="node3" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="324.13" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="324.13" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge2" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M176.14,-152.29C205.6,-139.89 256.79,-118.34 290.57,-104.12"></path>
<polygon fill="black" stroke="black" points="291.62,-107.48 299.48,-100.37 288.91,-101.03 291.62,-107.48"></polygon>
</g>
<!-- square2 -->
<g id="node4" class="node">
<title>square2</title>
<ellipse fill="none" stroke="black" cx="238.6" cy="-18" rx="67.53" ry="18"></ellipse>
<text text-anchor="middle" x="238.6" y="-12.57" font-family="Courier,monospace" font-size="14.00">square</text>
</g>
<!-- b&#45;&gt;square2 -->
<g id="edge3" class="edge">
<title>b-&gt;square2</title>
<path fill="none" stroke="black" d="M307.23,-75.78C296.08,-66.39 281.16,-53.83 268.08,-42.82"></path>
<polygon fill="black" stroke="black" points="270.45,-40.24 260.55,-36.48 265.95,-45.6 270.45,-40.24"></polygon>
</g>
<!-- 3 -->
<g id="node5" class="node">
<title>3</title>
<ellipse fill="none" stroke="black" cx="369.13" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="369.13" y="-12.57" font-family="Courier,monospace" font-size="14.00">3</text>
</g>
<!-- b&#45;&gt;3 -->
<g id="edge4" class="edge">
<title>b-&gt;3</title>
<path fill="none" stroke="black" d="M334.57,-73.3C339.96,-64.67 346.67,-53.93 352.74,-44.22"></path>
<polygon fill="black" stroke="black" points="355.61,-46.23 357.95,-35.89 349.68,-42.52 355.61,-46.23"></polygon>
</g>
</g>
</svg>

<p>The outermost redex is the top node - the outer application of <code>square</code>. To reduce it, we
replace the redex with an instance of the supercombinator body, substituting any
parameters with a pointer to the argument of the application. This gives us:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="216pt" height="260pt" viewBox="0.00 0.00 215.53 260.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)">
<polygon fill="white" stroke="none" points="-4,4 -4,-256 211.53,-256 211.53,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="blue" cx="96.53" cy="-234" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="96.53" y="-228.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="blue" cx="69.53" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="69.53" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="blue" d="M89.99,-216.05C87.01,-208.32 83.4,-198.96 80.05,-190.27"></path>
<polygon fill="blue" stroke="blue" points="83.42,-189.27 76.55,-181.2 76.88,-191.79 83.42,-189.27"></polygon>
</g>
<!-- c -->
<g id="node4" class="node">
<title>c</title>
<ellipse fill="none" stroke="black" cx="124.53" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="124.53" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;c -->
<g id="edge4" class="edge">
<title>a-&gt;c</title>
<path fill="none" stroke="blue" d="M99.91,-215.87C104.64,-191.88 113.29,-147.99 118.98,-119.16"></path>
<polygon fill="blue" stroke="blue" points="122.35,-120.16 120.85,-109.67 115.48,-118.81 122.35,-120.16"></polygon>
</g>
<!-- star -->
<g id="node3" class="node">
<title>star</title>
<ellipse fill="none" stroke="blue" cx="52.53" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="52.53" y="-84.58" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- b&#45;&gt;star -->
<g id="edge2" class="edge">
<title>b-&gt;star</title>
<path fill="none" stroke="blue" d="M65.42,-144.05C63.6,-136.6 61.43,-127.64 59.38,-119.22"></path>
<polygon fill="blue" stroke="blue" points="62.84,-118.64 57.08,-109.75 56.04,-120.29 62.84,-118.64"></polygon>
</g>
<!-- b&#45;&gt;c -->
<g id="edge3" class="edge">
<title>b-&gt;c</title>
<path fill="none" stroke="blue" d="M81.74,-145.46C88.64,-136.67 97.44,-125.48 105.26,-115.53"></path>
<polygon fill="blue" stroke="blue" points="108,-117.71 111.42,-107.68 102.49,-113.38 108,-117.71"></polygon>
</g>
<!-- square -->
<g id="node5" class="node">
<title>square</title>
<ellipse fill="none" stroke="black" cx="67.53" cy="-18" rx="67.53" ry="18"></ellipse>
<text text-anchor="middle" x="67.53" y="-12.57" font-family="Courier,monospace" font-size="14.00">square</text>
</g>
<!-- c&#45;&gt;square -->
<g id="edge5" class="edge">
<title>c-&gt;square</title>
<path fill="none" stroke="black" d="M112.16,-73.81C105.14,-65.19 96.18,-54.18 88.13,-44.29"></path>
<polygon fill="black" stroke="black" points="91.05,-42.35 82.03,-36.8 85.63,-46.77 91.05,-42.35"></polygon>
</g>
<!-- 3 -->
<g id="node6" class="node">
<title>3</title>
<ellipse fill="none" stroke="black" cx="180.53" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="180.53" y="-12.57" font-family="Courier,monospace" font-size="14.00">3</text>
</g>
<!-- c&#45;&gt;3 -->
<g id="edge6" class="edge">
<title>c-&gt;3</title>
<path fill="none" stroke="black" d="M136.68,-73.81C143.87,-64.82 153.14,-53.23 161.31,-43.03"></path>
<polygon fill="black" stroke="black" points="163.94,-45.34 167.46,-35.34 158.48,-40.96 163.94,-45.34"></polygon>
</g>
</g>
</svg>

<p>We see that the inner redex <code>(square 3)</code> is now shared between two application nodes.
Notice that this transformation has resulted in a true <em>graph</em> rather than a tree. The
subgraph coloured blue is the instantiated body of <code>square</code>.</p>
<p>The application of <code>*</code> cannot be reduced because <code>*</code> is a strict primitive and requires
both its arguments to be evaluated first. Hence the only redex is the inner <code>(square 3)</code>.
This yields:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="160pt" height="332pt" viewBox="0.00 0.00 160.00 332.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 328)">
<polygon fill="white" stroke="none" points="-4,4 -4,-328 156,-328 156,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="108" cy="-306" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="108" y="-300.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="53" cy="-234" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="53" y="-228.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M95.79,-289.46C88.89,-280.67 80.09,-269.48 72.27,-259.53"></path>
<polygon fill="black" stroke="black" points="75.04,-257.38 66.11,-251.68 69.53,-261.71 75.04,-257.38"></polygon>
</g>
<!-- 3 -->
<g id="node3" class="node">
<title>3</title>
<ellipse fill="none" stroke="blue" cx="125" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="125" y="-12.57" font-family="Courier,monospace" font-size="14.00">3</text>
</g>
<!-- a&#45;&gt;3 -->
<!-- c -->
<g id="node5" class="node">
<title>c</title>
<ellipse fill="none" stroke="blue" cx="99" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;c -->
<g id="edge4" class="edge">
<title>a-&gt;c</title>
<path fill="none" stroke="black" d="M106.9,-287.59C105.38,-263.61 102.62,-220.14 100.8,-191.42"></path>
<polygon fill="black" stroke="black" points="104.31,-191.38 100.18,-181.62 97.32,-191.82 104.31,-191.38"></polygon>
</g>
<!-- star1 -->
<g id="node4" class="node">
<title>star1</title>
<ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-156.57" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- b&#45;&gt;star1 -->
<g id="edge2" class="edge">
<title>b-&gt;star1</title>
<path fill="none" stroke="black" d="M46.71,-216.05C43.86,-208.4 40.43,-199.16 37.24,-190.56"></path>
<polygon fill="black" stroke="black" points="40.53,-189.36 33.76,-181.21 33.96,-191.8 40.53,-189.36"></polygon>
</g>
<!-- b&#45;&gt;c -->
<g id="edge3" class="edge">
<title>b-&gt;c</title>
<path fill="none" stroke="black" d="M63.44,-217.12C69.03,-208.61 76.04,-197.94 82.36,-188.32"></path>
<polygon fill="black" stroke="black" points="85.21,-190.37 87.77,-180.09 79.36,-186.52 85.21,-190.37"></polygon>
</g>
<!-- c&#45;&gt;3 -->
<g id="edge7" class="edge">
<title>c-&gt;3</title>
<path fill="none" stroke="blue" d="M102.14,-143.87C106.53,-119.88 114.56,-75.99 119.84,-47.16"></path>
<polygon fill="blue" stroke="blue" points="123.22,-48.14 121.58,-37.68 116.34,-46.88 123.22,-48.14"></polygon>
</g>
<!-- d -->
<g id="node6" class="node">
<title>d</title>
<ellipse fill="none" stroke="blue" cx="61" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="61" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- c&#45;&gt;d -->
<g id="edge5" class="edge">
<title>c-&gt;d</title>
<path fill="none" stroke="blue" d="M90.19,-144.76C85.73,-136.55 80.2,-126.37 75.16,-117.09"></path>
<polygon fill="blue" stroke="blue" points="78.33,-115.6 70.49,-108.48 72.18,-118.94 78.33,-115.6"></polygon>
</g>
<!-- d&#45;&gt;3 -->
<g id="edge8" class="edge">
<title>d-&gt;3</title>
<path fill="none" stroke="blue" d="M74.57,-74.15C83.06,-64.87 94.17,-52.73 103.8,-42.19"></path>
<polygon fill="blue" stroke="blue" points="106.26,-44.68 110.43,-34.94 101.09,-39.96 106.26,-44.68"></polygon>
</g>
<!-- star2 -->
<g id="node7" class="node">
<title>star2</title>
<ellipse fill="none" stroke="blue" cx="53" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="53" y="-12.57" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- d&#45;&gt;star2 -->
<g id="edge6" class="edge">
<title>d-&gt;star2</title>
<path fill="none" stroke="blue" d="M59.02,-71.7C58.19,-64.41 57.2,-55.73 56.26,-47.54"></path>
<polygon fill="blue" stroke="blue" points="59.74,-47.15 55.13,-37.61 52.78,-47.94 59.74,-47.15"></polygon>
</g>
</g>
</svg>

<p>The subgraph coloured blue is the second instantiation of <code>square</code>. The only redex is now
the inner multiplication, so we reduce that.</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="134pt" height="188pt" viewBox="0.00 0.00 134.00 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<polygon fill="white" stroke="none" points="-4,4 -4,-184 130,-184 130,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="71" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="71" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="44" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="44" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M64.46,-144.05C61.48,-136.32 57.87,-126.96 54.52,-118.27"></path>
<polygon fill="black" stroke="black" points="57.88,-117.27 51.02,-109.2 51.35,-119.79 57.88,-117.27"></polygon>
</g>
<!-- nine -->
<g id="node4" class="node">
<title>nine</title>
<ellipse fill="none" stroke="black" cx="99" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-12.57" font-family="Courier,monospace" font-size="14.00">9</text>
</g>
<!-- a&#45;&gt;nine -->
<g id="edge3" class="edge">
<title>a-&gt;nine</title>
<path fill="none" stroke="black" d="M74.38,-143.87C79.11,-119.88 87.76,-75.99 93.45,-47.16"></path>
<polygon fill="black" stroke="black" points="96.82,-48.16 95.32,-37.67 89.95,-46.81 96.82,-48.16"></polygon>
</g>
<!-- * -->
<g id="node3" class="node">
<title>*</title>
<ellipse fill="none" stroke="black" cx="27" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-12.57" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- b&#45;&gt;* -->
<g id="edge2" class="edge">
<title>b-&gt;*</title>
<path fill="none" stroke="black" d="M39.88,-72.05C38.07,-64.6 35.9,-55.64 33.85,-47.22"></path>
<polygon fill="black" stroke="black" points="37.31,-46.64 31.55,-37.75 30.51,-48.29 37.31,-46.64"></polygon>
</g>
<!-- b&#45;&gt;nine -->
<g id="edge4" class="edge">
<title>b-&gt;nine</title>
<path fill="none" stroke="black" d="M56.21,-73.46C63.11,-64.67 71.91,-53.48 79.73,-43.53"></path>
<polygon fill="black" stroke="black" points="82.47,-45.71 85.89,-35.68 76.96,-41.38 82.47,-45.71"></polygon>
</g>
</g>
</svg>

<p>And now we can reduce the outer multiplication, which directly yields <code>81</code>.</p>
<p>So the general steps are:</p>
<ol type="1">
<li>Find the next redex</li>
<li>Reduce it</li>
<li>Update the root of the redex with the result</li>
</ol>
<h2 id="unwinding-the-spine">Unwinding the spine</h2>
<p>To find the next redex, we need to find the leftmost outermost function application. To do
that we follow these steps:</p>
<ol type="1">
<li>From the root of the graph, follow the left branch until you reach a supercombinator or
primitive.</li>
<li>Check how many arguments the supercombinator or primitive takes and go back up the
graph that number of times - you’re now at the root of the outermost function application.</li>
</ol>
<p>The chain of left-branching application nodes is called the <em>spine</em>, and the process of
traversing it like this is called known as <em>unwinding</em> the spine. The function arguments
are typically stored on a stack to make them easy to access.</p>
<p>If the function is a supercombinator, then we’ve found a redex. If it’s a primitive, then
we may first need to reduce the arguments to the function before the application becomes
reducible.</p>
<p>If we need to reduce an argument, we must put the current stack to one side and begin
unwinding again from the root of the argument. We may need to repeat this if the argument
contains further unevaluated function applications. To keep track of these stacks we use
a stack of stacks, known as a <em>dump</em>. When we need to evaluate an argument we push the
current stack on to the dump, and when we’ve finished evaluating it we pop the old stack
off the dump.</p>
<h2 id="reducing-letrec-expressions">Reducing <code>let(rec)</code> expressions</h2>
<p>A supercombinator is reduced by substituting arguments into its body. If there are
<code>let(rec)</code> expressions in the body, they are represented as paths in the graph. For
example:</p>
<pre><code>let y = 3
 in + y y</code></pre>
<p>is represented as</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="134pt" height="188pt" viewBox="0.00 0.00 134.00 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<polygon fill="white" stroke="none" points="-4,4 -4,-184 130,-184 130,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="71" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="71" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="44" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="44" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M64.46,-144.05C61.48,-136.32 57.87,-126.96 54.52,-118.27"></path>
<polygon fill="black" stroke="black" points="57.88,-117.27 51.02,-109.2 51.35,-119.79 57.88,-117.27"></polygon>
</g>
<!-- 3 -->
<g id="node4" class="node">
<title>3</title>
<ellipse fill="none" stroke="black" cx="99" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-12.57" font-family="Courier,monospace" font-size="14.00">3</text>
</g>
<!-- a&#45;&gt;3 -->
<g id="edge4" class="edge">
<title>a-&gt;3</title>
<path fill="none" stroke="black" d="M74.38,-143.87C79.11,-119.88 87.76,-75.99 93.45,-47.16"></path>
<polygon fill="black" stroke="black" points="96.82,-48.16 95.32,-37.67 89.95,-46.81 96.82,-48.16"></polygon>
</g>
<!-- + -->
<g id="node3" class="node">
<title>+</title>
<ellipse fill="none" stroke="black" cx="27" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-12.57" font-family="Courier,monospace" font-size="14.00">+</text>
</g>
<!-- b&#45;&gt;+ -->
<g id="edge2" class="edge">
<title>b-&gt;+</title>
<path fill="none" stroke="black" d="M39.88,-72.05C38.07,-64.6 35.9,-55.64 33.85,-47.22"></path>
<polygon fill="black" stroke="black" points="37.31,-46.64 31.55,-37.75 30.51,-48.29 37.31,-46.64"></polygon>
</g>
<!-- b&#45;&gt;3 -->
<g id="edge3" class="edge">
<title>b-&gt;3</title>
<path fill="none" stroke="black" d="M56.21,-73.46C63.11,-64.67 71.91,-53.48 79.73,-43.53"></path>
<polygon fill="black" stroke="black" points="82.47,-45.71 85.89,-35.68 76.96,-41.38 82.47,-45.71"></polygon>
</g>
</g>
</svg>

<p>The <code>let</code> expression defines a sub-expression <code>3</code>, which is named <code>y</code>. The body of the
<code>let</code> expression references <code>y</code> via pointers to <code>3</code>. In this way, the single instance of
<code>y</code> is shared between the two arguments to <code>+</code>.</p>
<p>Let’s look at a more complex example: the reduction of a supercombinator application.</p>
<pre><code>f x = let y = * x x
       in + y y
main = f 3</code></pre>
<p>We start with the <code>main</code> supercombinator:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="105pt" height="44pt" viewBox="0.00 0.00 105.14 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<polygon fill="white" stroke="none" points="-4,4 -4,-40 101.14,-40 101.14,4 -4,4"></polygon>
<!-- main -->
<g id="node1" class="node">
<title>main</title>
<ellipse fill="none" stroke="black" cx="48.57" cy="-18" rx="48.57" ry="18"></ellipse>
<text text-anchor="middle" x="48.57" y="-12.57" font-family="Courier,monospace" font-size="14.00">main</text>
</g>
</g>
</svg>

<p>which reduces to</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="134pt" height="116pt" viewBox="0.00 0.00 134.00 116.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 112)">
<polygon fill="white" stroke="none" points="-4,4 -4,-112 130,-112 130,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="63" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="63" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- f -->
<g id="node2" class="node">
<title>f</title>
<ellipse fill="none" stroke="black" cx="27" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-12.57" font-family="Courier,monospace" font-size="14.00">f</text>
</g>
<!-- a&#45;&gt;f -->
<g id="edge1" class="edge">
<title>a-&gt;f</title>
<path fill="none" stroke="black" d="M54.65,-72.76C50.42,-64.55 45.19,-54.37 40.42,-45.09"></path>
<polygon fill="black" stroke="black" points="43.68,-43.79 36,-36.49 37.46,-46.99 43.68,-43.79"></polygon>
</g>
<!-- 3 -->
<g id="node3" class="node">
<title>3</title>
<ellipse fill="none" stroke="black" cx="99" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-12.57" font-family="Courier,monospace" font-size="14.00">3</text>
</g>
<!-- a&#45;&gt;3 -->
<g id="edge2" class="edge">
<title>a-&gt;3</title>
<path fill="none" stroke="black" d="M71.35,-72.76C75.58,-64.55 80.81,-54.37 85.58,-45.09"></path>
<polygon fill="black" stroke="black" points="88.54,-46.99 90,-36.49 82.32,-43.79 88.54,-46.99"></polygon>
</g>
</g>
</svg>

<p>which reduces to</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="196pt" height="332pt" viewBox="0.00 0.00 196.05 332.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 328)">
<polygon fill="white" stroke="none" points="-4,4 -4,-328 192.05,-328 192.05,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="102" cy="-306" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="102" y="-300.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="75" cy="-234" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="75" y="-228.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M95.46,-288.05C92.48,-280.32 88.87,-270.96 85.52,-262.27"></path>
<polygon fill="black" stroke="black" points="88.88,-261.27 82.02,-253.2 82.35,-263.79 88.88,-261.27"></polygon>
</g>
<!-- c -->
<g id="node4" class="node">
<title>c</title>
<ellipse fill="none" stroke="black" cx="130" cy="-162" rx="58.05" ry="18"></ellipse>
<text text-anchor="middle" x="130" y="-156.57" font-family="Courier,monospace" font-size="14.00">@ (y)</text>
</g>
<!-- a&#45;&gt;c -->
<g id="edge3" class="edge">
<title>a-&gt;c</title>
<path fill="none" stroke="black" d="M105.38,-287.87C110.11,-263.88 118.76,-219.99 124.45,-191.16"></path>
<polygon fill="black" stroke="black" points="127.82,-192.16 126.32,-181.67 120.95,-190.81 127.82,-192.16"></polygon>
</g>
<!-- + -->
<g id="node3" class="node">
<title>+</title>
<ellipse fill="none" stroke="black" cx="27" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-156.57" font-family="Courier,monospace" font-size="14.00">+</text>
</g>
<!-- b&#45;&gt;+ -->
<g id="edge2" class="edge">
<title>b-&gt;+</title>
<path fill="none" stroke="black" d="M64.11,-217.12C58.22,-208.52 50.8,-197.72 44.16,-188.02"></path>
<polygon fill="black" stroke="black" points="47.25,-186.34 38.7,-180.07 41.47,-190.3 47.25,-186.34"></polygon>
</g>
<!-- b&#45;&gt;c -->
<g id="edge4" class="edge">
<title>b-&gt;c</title>
<path fill="none" stroke="black" d="M87.21,-217.46C93.83,-209.04 102.18,-198.41 109.74,-188.78"></path>
<polygon fill="black" stroke="black" points="112.31,-191.18 115.74,-181.15 106.81,-186.85 112.31,-191.18"></polygon>
</g>
<!-- d -->
<g id="node5" class="node">
<title>d</title>
<ellipse fill="none" stroke="black" cx="102" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="102" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- c&#45;&gt;d -->
<g id="edge5" class="edge">
<title>c-&gt;d</title>
<path fill="none" stroke="black" d="M123.08,-143.7C120.02,-136.04 116.34,-126.85 112.92,-118.3"></path>
<polygon fill="black" stroke="black" points="116.17,-117.01 109.21,-109.03 109.68,-119.61 116.17,-117.01"></polygon>
</g>
<!-- 3 -->
<g id="node7" class="node">
<title>3</title>
<ellipse fill="none" stroke="black" cx="157" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="157" y="-12.57" font-family="Courier,monospace" font-size="14.00">3</text>
</g>
<!-- c&#45;&gt;3 -->
<g id="edge7" class="edge">
<title>c-&gt;3</title>
<path fill="none" stroke="black" d="M133.31,-143.59C137.87,-119.61 146.13,-76.14 151.6,-47.42"></path>
<polygon fill="black" stroke="black" points="155.03,-48.08 153.46,-37.6 148.16,-46.77 155.03,-48.08"></polygon>
</g>
<!-- * -->
<g id="node6" class="node">
<title>*</title>
<ellipse fill="none" stroke="black" cx="85" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="85" y="-12.57" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- d&#45;&gt;* -->
<g id="edge6" class="edge">
<title>d-&gt;*</title>
<path fill="none" stroke="black" d="M97.88,-72.05C96.07,-64.6 93.9,-55.64 91.85,-47.22"></path>
<polygon fill="black" stroke="black" points="95.31,-46.64 89.55,-37.75 88.51,-48.29 95.31,-46.64"></polygon>
</g>
<!-- d&#45;&gt;3 -->
<g id="edge8" class="edge">
<title>d-&gt;3</title>
<path fill="none" stroke="black" d="M114.21,-73.46C121.11,-64.67 129.91,-53.48 137.73,-43.53"></path>
<polygon fill="black" stroke="black" points="140.47,-45.71 143.89,-35.68 134.96,-41.38 140.47,-45.71"></polygon>
</g>
</g>
</svg>

<p>We can see that both arguments to <code>+</code> point to the same sub-expression (labelled <code>y</code>) and
both arguments to <code>*</code> point to the same instance of <code>3</code>. The outermost application is that
of <code>+</code>, but it requires both of its arguments to be evaluated first. Both arguments are
the inner application of <code>*</code>, which we can reduce. This gives us the following:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="134pt" height="188pt" viewBox="0.00 0.00 134.00 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<polygon fill="white" stroke="none" points="-4,4 -4,-184 130,-184 130,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<ellipse fill="none" stroke="black" cx="71" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="71" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<ellipse fill="none" stroke="black" cx="44" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="44" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M64.46,-144.05C61.48,-136.32 57.87,-126.96 54.52,-118.27"></path>
<polygon fill="black" stroke="black" points="57.88,-117.27 51.02,-109.2 51.35,-119.79 57.88,-117.27"></polygon>
</g>
<!-- 9 -->
<g id="node4" class="node">
<title>9</title>
<ellipse fill="none" stroke="black" cx="99" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-12.57" font-family="Courier,monospace" font-size="14.00">9</text>
</g>
<!-- a&#45;&gt;9 -->
<g id="edge3" class="edge">
<title>a-&gt;9</title>
<path fill="none" stroke="black" d="M74.38,-143.87C79.11,-119.88 87.76,-75.99 93.45,-47.16"></path>
<polygon fill="black" stroke="black" points="96.82,-48.16 95.32,-37.67 89.95,-46.81 96.82,-48.16"></polygon>
</g>
<!-- + -->
<g id="node3" class="node">
<title>+</title>
<ellipse fill="none" stroke="black" cx="27" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-12.57" font-family="Courier,monospace" font-size="14.00">+</text>
</g>
<!-- b&#45;&gt;+ -->
<g id="edge2" class="edge">
<title>b-&gt;+</title>
<path fill="none" stroke="black" d="M39.88,-72.05C38.07,-64.6 35.9,-55.64 33.85,-47.22"></path>
<polygon fill="black" stroke="black" points="37.31,-46.64 31.55,-37.75 30.51,-48.29 37.31,-46.64"></polygon>
</g>
<!-- b&#45;&gt;9 -->
<g id="edge4" class="edge">
<title>b-&gt;9</title>
<path fill="none" stroke="black" d="M56.21,-73.46C63.11,-64.67 71.91,-53.48 79.73,-43.53"></path>
<polygon fill="black" stroke="black" points="82.47,-45.71 85.89,-35.68 76.96,-41.38 82.47,-45.71"></polygon>
</g>
</g>
</svg>

<p>which reduces to</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="67pt" height="44pt" viewBox="0.00 0.00 67.21 44.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 40)">
<polygon fill="white" stroke="none" points="-4,4 -4,-40 63.21,-40 63.21,4 -4,4"></polygon>
<!-- 18 -->
<g id="node1" class="node">
<title>18</title>
<ellipse fill="none" stroke="black" cx="29.61" cy="-18" rx="29.61" ry="18"></ellipse>
<text text-anchor="middle" x="29.61" y="-12.57" font-family="Courier,monospace" font-size="14.00">18</text>
</g>
</g>
</svg>

<h2 id="reducing-supercombinator-applications">Reducing supercombinator applications</h2>
<p>When reducing a supercombinator application, there are two things we must consider:</p>
<ol type="1">
<li>The argument may contain redexes, so we want to avoid copying it.</li>
<li>The redex may be shared, so we want to update it with its result after reduction.</li>
</ol>
<p>To do this we construct a new instance of the supercombinator body, substituting a
<em>pointer</em> to the argument in place of the function parameter. This avoids having to copy
the argument, which may be large. Once we’ve reduced a redex, we overwrite the root of the
redex with the result of the reduction. This ensures that any other references to it will
not have to reduce it again.</p>
<p>There’s one case we need to be careful of, however. Consider the following Core program:</p>
<pre><code>id x = x
main = let y = 4
        in * (id y) y</code></pre>
<p>After some reduction, the graph of this program looks like this:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="189pt" height="260pt" viewBox="0.00 0.00 189.00 260.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)">
<polygon fill="white" stroke="none" points="-4,4 -4,-256 185,-256 185,4 -4,4"></polygon>
<!-- a1 -->
<g id="node1" class="node">
<title>a1</title>
<ellipse fill="none" stroke="black" cx="126" cy="-234" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="126" y="-228.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a2 -->
<g id="node2" class="node">
<title>a2</title>
<ellipse fill="none" stroke="black" cx="99" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a1&#45;&gt;a2 -->
<g id="edge1" class="edge">
<title>a1-&gt;a2</title>
<path fill="none" stroke="black" d="M119.46,-216.05C116.48,-208.32 112.87,-198.96 109.52,-190.27"></path>
<polygon fill="black" stroke="black" points="112.88,-189.27 106.02,-181.2 106.35,-191.79 112.88,-189.27"></polygon>
</g>
<!-- 4 -->
<g id="node3" class="node">
<title>4</title>
<ellipse fill="none" stroke="black" cx="154" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="154" y="-12.57" font-family="Courier,monospace" font-size="14.00">4</text>
</g>
<!-- a1&#45;&gt;4 -->
<g id="edge2" class="edge">
<title>a1-&gt;4</title>
<path fill="none" stroke="black" d="M129.14,-215.85C130.98,-205.49 133.27,-192.01 135,-180 141.64,-133.81 147.65,-79.91 151.06,-47.67"></path>
<polygon fill="black" stroke="black" points="154.52,-48.24 152.08,-37.94 147.56,-47.52 154.52,-48.24"></polygon>
</g>
<!-- * -->
<g id="node4" class="node">
<title>*</title>
<ellipse fill="none" stroke="black" cx="27" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-84.58" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- a2&#45;&gt;* -->
<g id="edge3" class="edge">
<title>a2-&gt;*</title>
<path fill="none" stroke="black" d="M84.08,-146.5C74.23,-136.92 61.14,-124.19 49.97,-113.34"></path>
<polygon fill="black" stroke="black" points="52.59,-111 42.98,-106.54 47.71,-116.02 52.59,-111"></polygon>
</g>
<!-- y -->
<g id="node5" class="node">
<title>y</title>
<ellipse fill="none" stroke="black" cx="99" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a2&#45;&gt;y -->
<g id="edge6" class="edge">
<title>a2-&gt;y</title>
<path fill="none" stroke="black" d="M99,-143.7C99,-136.41 99,-127.73 99,-119.54"></path>
<polygon fill="black" stroke="black" points="102.5,-119.62 99,-109.62 95.5,-119.62 102.5,-119.62"></polygon>
</g>
<!-- y&#45;&gt;4 -->
<g id="edge5" class="edge">
<title>y-&gt;4</title>
<path fill="none" stroke="black" d="M111.21,-73.46C118.11,-64.67 126.91,-53.48 134.73,-43.53"></path>
<polygon fill="black" stroke="black" points="137.47,-45.71 140.89,-35.68 131.96,-41.38 137.47,-45.71"></polygon>
</g>
<!-- id -->
<g id="node6" class="node">
<title>id</title>
<ellipse fill="none" stroke="black" cx="79" cy="-18" rx="29.61" ry="18"></ellipse>
<text text-anchor="middle" x="79" y="-12.57" font-family="Courier,monospace" font-size="14.00">id</text>
</g>
<!-- y&#45;&gt;id -->
<g id="edge4" class="edge">
<title>y-&gt;id</title>
<path fill="none" stroke="black" d="M94.16,-72.05C92,-64.49 89.39,-55.37 86.96,-46.85"></path>
<polygon fill="black" stroke="black" points="90.33,-45.9 84.21,-37.24 83.59,-47.82 90.33,-45.9"></polygon>
</g>
</g>
</svg>

<p>Let’s consider the reduction of <code>(id 4)</code>. If we were to naively update the root of the
redex with the result, we’d end up with the following.</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="170pt" height="188pt" viewBox="0.00 0.00 170.00 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<polygon fill="white" stroke="none" points="-4,4 -4,-184 166,-184 166,4 -4,4"></polygon>
<!-- a1 -->
<g id="node1" class="node">
<title>a1</title>
<ellipse fill="none" stroke="black" cx="99" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a2 -->
<g id="node2" class="node">
<title>a2</title>
<ellipse fill="none" stroke="black" cx="63" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="63" y="-84.58" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a1&#45;&gt;a2 -->
<g id="edge1" class="edge">
<title>a1-&gt;a2</title>
<path fill="none" stroke="black" d="M90.65,-144.76C86.42,-136.55 81.19,-126.37 76.42,-117.09"></path>
<polygon fill="black" stroke="black" points="79.68,-115.79 72,-108.49 73.46,-118.99 79.68,-115.79"></polygon>
</g>
<!-- 4 -->
<g id="node3" class="node">
<title>4</title>
<ellipse fill="none" stroke="black" cx="135" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="135" y="-84.58" font-family="Courier,monospace" font-size="14.00">4</text>
</g>
<!-- a1&#45;&gt;4 -->
<g id="edge2" class="edge">
<title>a1-&gt;4</title>
<path fill="none" stroke="black" d="M107.35,-144.76C111.58,-136.55 116.81,-126.37 121.58,-117.09"></path>
<polygon fill="black" stroke="black" points="124.54,-118.99 126,-108.49 118.32,-115.79 124.54,-118.99"></polygon>
</g>
<!-- * -->
<g id="node4" class="node">
<title>*</title>
<ellipse fill="none" stroke="black" cx="27" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-12.57" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- a2&#45;&gt;* -->
<g id="edge3" class="edge">
<title>a2-&gt;*</title>
<path fill="none" stroke="black" d="M54.65,-72.76C50.42,-64.55 45.19,-54.37 40.42,-45.09"></path>
<polygon fill="black" stroke="black" points="43.68,-43.79 36,-36.49 37.46,-46.99 43.68,-43.79"></polygon>
</g>
<!-- z -->
<g id="node5" class="node">
<title>z</title>
<ellipse fill="none" stroke="black" cx="99" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-12.57" font-family="Courier,monospace" font-size="14.00">4</text>
</g>
<!-- a2&#45;&gt;z -->
<g id="edge4" class="edge">
<title>a2-&gt;z</title>
<path fill="none" stroke="black" d="M71.35,-72.76C75.58,-64.55 80.81,-54.37 85.58,-45.09"></path>
<polygon fill="black" stroke="black" points="88.54,-46.99 90,-36.49 82.32,-43.79 88.54,-46.99"></polygon>
</g>
</g>
</svg>

<p>We’ve duplicated <code>4</code>! If this was a large expression, we would be at risk of doing extra
work reducing it twice. To get around this, we can add a new type of node: an <em>indirection
node</em>. This node simply points to another node, and we can use it to update the root of
the redex without duplicating the result. Using an indirection node (marked by a <code>#</code>) we
get the following:</p>
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Pages: 1 -->
<svg width="161pt" height="260pt" viewBox="0.00 0.00 161.00 260.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)">
<polygon fill="white" stroke="none" points="-4,4 -4,-256 157,-256 157,4 -4,4"></polygon>
<!-- a1 -->
<g id="node1" class="node">
<title>a1</title>
<ellipse fill="none" stroke="black" cx="126" cy="-234" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="126" y="-228.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a2 -->
<g id="node2" class="node">
<title>a2</title>
<ellipse fill="none" stroke="black" cx="99" cy="-162" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-156.57" font-family="Courier,monospace" font-size="14.00">@</text>
</g>
<!-- a1&#45;&gt;a2 -->
<g id="edge1" class="edge">
<title>a1-&gt;a2</title>
<path fill="none" stroke="black" d="M119.46,-216.05C116.48,-208.32 112.87,-198.96 109.52,-190.27"></path>
<polygon fill="black" stroke="black" points="112.88,-189.27 106.02,-181.2 106.35,-191.79 112.88,-189.27"></polygon>
</g>
<!-- 4 -->
<g id="node3" class="node">
<title>4</title>
<ellipse fill="none" stroke="black" cx="126" cy="-18" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="126" y="-12.57" font-family="Courier,monospace" font-size="14.00">4</text>
</g>
<!-- a1&#45;&gt;4 -->
<g id="edge2" class="edge">
<title>a1-&gt;4</title>
<path fill="none" stroke="black" d="M129.65,-215.91C131.68,-205.57 133.98,-192.09 135,-180 139.03,-132.17 139.03,-119.83 135,-72 134.32,-63.97 133.08,-55.33 131.73,-47.4"></path>
<polygon fill="black" stroke="black" points="135.17,-46.79 129.93,-37.58 128.29,-48.05 135.17,-46.79"></polygon>
</g>
<!-- * -->
<g id="node4" class="node">
<title>*</title>
<ellipse fill="none" stroke="black" cx="27" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="27" y="-84.58" font-family="Courier,monospace" font-size="14.00">*</text>
</g>
<!-- a2&#45;&gt;* -->
<g id="edge3" class="edge">
<title>a2-&gt;*</title>
<path fill="none" stroke="black" d="M84.08,-146.5C74.23,-136.92 61.14,-124.19 49.97,-113.34"></path>
<polygon fill="black" stroke="black" points="52.59,-111 42.98,-106.54 47.71,-116.02 52.59,-111"></polygon>
</g>
<!-- ind -->
<g id="node5" class="node">
<title>ind</title>
<ellipse fill="none" stroke="black" cx="99" cy="-90" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="99" y="-84.58" font-family="Courier,monospace" font-size="14.00">#</text>
</g>
<!-- a2&#45;&gt;ind -->
<g id="edge5" class="edge">
<title>a2-&gt;ind</title>
<path fill="none" stroke="black" d="M99,-143.7C99,-136.41 99,-127.73 99,-119.54"></path>
<polygon fill="black" stroke="black" points="102.5,-119.62 99,-109.62 95.5,-119.62 102.5,-119.62"></polygon>
</g>
<!-- ind&#45;&gt;4 -->
<g id="edge4" class="edge">
<title>ind-&gt;4</title>
<path fill="none" stroke="black" d="M105.54,-72.05C108.52,-64.32 112.13,-54.96 115.48,-46.27"></path>
<polygon fill="black" stroke="black" points="118.65,-47.79 118.98,-37.2 112.12,-45.27 118.65,-47.79"></polygon>
</g>
</g>
</svg>

<p>We can then reduce this in the normal way. When we encounter an indirection node we simply
skip over it and look at its target. In one step this reduces to <code>16</code>.</p>
<p>Those are the basics of graph reduction. In the next section we’ll apply this theory to
our first compiler: the template instantiation machine.</p>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>In this case we could call it a tree, but trees are just a specific type of graph.
Later on we’ll see that certain transformations on the tree will make it no longer a valid
tree. So for simplicity we’ll refer to everything as a graph.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
      </div>
    </div>
  </body>
</html>
